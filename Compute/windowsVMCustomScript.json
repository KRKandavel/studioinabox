{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Location to deploy current resource"
            }
        },
        "vmName": {
            "type": "string",
            "defaultValue": "hxcore"
        },
        "vmSize": {
            "type": "string",
            "defaultValue": "Standard_B2s",
            "metadata": {
                "description": "Please select the size of the VM you wish to deploy.  Read more about sizing options here: https://docs.microsoft.com/en-us/azure/virtual-machines/linux/sizes-general. Compute optimized instances recommended for production use, e.g. Fsv2 series"
            }
        },
        "dataDiskSize": {
            "type": "int",
            "minValue": 10,
            "maxValue": 2048,
            "defaultValue": 50,
            "metadata": {
                "description": "Please select the size of the data disk you wish to deploy (value is integer GB) to hold your metadata, logs and depot (archive files). This can be any value up to 2TB (2048 GB)."
            }
        },
        "nicName": {
            "type": "string",
            "defaultValue": "hxnic"
        },
        "OS": {
            "type": "string",
            "allowedValues": [
                "Windows Server 2019"
            ],
            "defaultValue": "CentOS 7.x",
            "metadata": {
                "description": "The operating system of the VM."
            }
        },
        "adminUsername": {
            "type": "string",
            "metadata": {
                "description": "Admin username for Virtual Machine"
            }
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Password or ssh key for the Virtual Machine."
            }
        },
        "scriptFolder": {
            "type": "string",
            "defaultValue": "Scripts"
        },
        "scriptFilename": {
            "type": "string",
            "defaultValue": "jenkins-java8.ps1",
            "allowedValues": [
                "jenkins-java8.ps1",
                "az-500.ps1",
                "container-lab.ps1",
                "container-vs2019-lab.ps1"
            ],
            "metadata": {
                "description": "Choose script to launch from list of available scripts"
            }
        },
        "scriptParameters": {
            "type": "string",
            "defaultValue": ""
        },
        "storageAccountName": {
            "type": "string",
            "defaultValue": "hxstore",
            "metadata": {
                "description": "Name of the storage account"
            }
        },
        "vmIdentitySetting": {
            "type": "string",
            "defaultValue": "None",
            "allowedValues": [
                "None",
                "SystemAssigned"
            ],
            "metadata": {
                "description": "Determines whether or not managed identity should be configured."
            }
        },
        "_artifactsLocation": {
            "type": "string",
            "metadata": {
                "description": "The base URI where artifacts required by this template are located. When the template is deployed using the accompanying scripts, a private location in the subscription will be used and this value will be automatically generated."
            },
            "defaultValue": "[deployment().properties.templateLink.uri]"
        },
        "_artifactsLocationSasToken": {
            "type": "securestring",
            "metadata": {
                "description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated."
            },
            "defaultValue": ""
        }
    },
    "variables": {
        //        "strname": "[toLower(concat('labvmstg',uniqueString(resourceGroup().id)))]",
        //        "scriptUrl": "[uri(parameters('_artifactsLocation'),concat(parameters('scriptFilename'),parameters('_artifactsLocationSasToken')))]"
        //        "LinuxScriptParameters": "[concat(' -w ''', parameters('helix_admin_password'), ''' -p ''', parameters('p4Port'), ''' -s ''', parameters('swarmPort'), '''')]",
        //        "LiCmdWrapper": "[concat('bash ./configure-linux.sh ', variables('LinuxScriptParameters'))]",
        //        "LinuxScriptParameters": "[concat('-w ', parameters('helix_admin_password'), ' -p ', parameters('p4Port'), ' -s ', parameters('swarmPort'))]",

        "imageReference": {
            "Windows Server 2019": {
                "publisher": "MicrosoftWindowsServer",
                "offer": "WindowsServer",
                "sku": "2019-Datacenter",
                "version": "latest"
            }
        },
        "dataDiskSize": "[parameters('dataDiskSize')]",
        "scriptFileName": "[parameters('scriptFilename')]",
        "scriptPath": "[concat(parameters('scriptFolder'), '/', parameters('scriptFilename'))]",
        "windowsscripturi": "[uri(parameters('_artifactsLocation'), concat(variables('scriptPath'), parameters('_artifactsLocationSasToken')))]",
        "WindowsScriptParameters": "[parameters('scriptParameters')]",
        "WinCmdWrapper": "[concat('powershell -ExecutionPolicy Bypass -file  ', variables('scriptPath'), ' ', variables('WindowsScriptParameters'))]"
    },
    "resources": [
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-07-01",
            "name": "[parameters('vmName')]",
            "location": "[parameters('location')]",
            "dependsOn": [
            ],
            "identity": {
                "type": "[parameters('vmIdentitySetting')]"
            },
            "tags": {
            },
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[parameters('vmSize')]"
                },
                "osProfile": {
                    "computerName": "[parameters('vmName')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]"
                },
                "storageProfile": {
                    "imageReference": "[variables('imageReference')[parameters('OS')]]",
                    "osDisk": {
                        "name": "[concat(parameters('vmName'), '-OSDisk')]",
                        "caching": "ReadWrite",
                        "createOption": "FromImage"
                    },
                    "dataDisks": [
                        {
                            "name": "[concat(parameters('vmName'), '-DataDisk1')]",
                            "diskSizeGB": "[variables('dataDiskSize')]",
                            "lun": 0,
                            "createOption": "Empty"
                        }
                    ]
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', parameters('nicName'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[reference(resourceId('Microsoft.Storage/storageAccounts/', parameters('storageAccountName')), '2018-02-01').primaryEndpoints.blob]"
                    }
                }
            }
        },
        {
            "apiVersion": "2018-06-01",
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "[concat(parameters('vmName'), '/installScript')]",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[concat('Microsoft.Compute/virtualMachines/', parameters('vmName'))]"
            ],
            "tags": {
                "displayName": "config-app"
            },
            "properties": {
                "publisher": "Microsoft.Compute",
                "type": "CustomScriptExtension",
                "typeHandlerVersion": "1.10",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "timestamp": 123456789
                },
                "protectedSettings": {
                    "commandToExecute": "[variables('WinCmdWrapper')]",
                    "managedIdentity": {},
                    "fileUris": [
                        "[variables('windowsscripturi')]"
                    ]
                }
            }
        }
    ],
    "outputs": {
        "resourceID": {
            "type": "string",
            "value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
        },
        "vmPrincipalID": {
            "type": "string",
//            "value": "[reference(resourceId('Microsoft.Compute/virtualMachines', parameters('vmName')), '2019-07-01', 'full').identity.principalId]"
            "value": "[if(equals(parameters('vmIdentitySetting'), 'None'), 'None', reference(resourceId('Microsoft.Compute/virtualMachines', parameters('vmName')), '2019-07-01', 'full').identity.principalId)]"
        }
    }
}
