{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Location to deploy current resource"
            }
        },
        "vmName": {
            "type": "string",
            "defaultValue": "hxcore"
        },
        "vmSize": {
            "type": "string",
            "defaultValue": "Standard_B2s",
            "metadata": {
                "description": "Please select the size of the VM you wish to deploy.  Read more about sizing options here: https://docs.microsoft.com/en-us/azure/virtual-machines/linux/sizes-general. Compute optimized instances recommended for production use, e.g. Fsv2 series"
            }
        },
        "rootDiskType": {
            "type": "string",
            "defaultValue": "Standard_LRS",
            "allowedValues": [
                "Standard_LRS",
                "StandardSSD_LRS",
                "Premium_LRS"
            ],
            "metadata": {
                "description": "Please select the type of the data disk you wish to deploy to hold your metadata, logs and depot (archive files). This can be any value up to 2TB (2048 GB)."
            }
        },
        "rootDiskSize": {
            "type": "int",
            "minValue": 25,
            "maxValue": 2048,
            "defaultValue": 25,
            "metadata": {
                "description": "Please select the size of the data disk you wish to deploy (value is integer GB) to hold your metadata, logs and depot (archive files). This can be any value up to 2TB (2048 GB)."
            }
        },
        "nicName": {
            "type": "string",
            "defaultValue": "hxnic"
        },
        "OS": {
            "type": "string",
            "allowedValues": [
                "Windows Server 2019",
                "Windows Server 2016"
            ],
            "defaultValue": "Windows Server 2019",
            "metadata": {
                "description": "The operating system of the VM."
            }
        },
        "adminUsername": {
            "type": "string",
            "metadata": {
                "description": "Admin username for Virtual Machine"
            }
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Password or ssh key for the Virtual Machine."
            }
        },
        "storageAccountName": {
            "type": "string",
            "defaultValue": "hxstore",
            "metadata": {
                "description": "Name of the storage account"
            }
        },
        "vmIdentitySetting": {
            "type": "string",
            "defaultValue": "None",
            "allowedValues": [
                "None",
                "SystemAssigned"
            ],
            "metadata": {
                "description": "Determines whether or not managed identity should be configured."
            }
        },
        "_artifactsLocation": {
            "type": "string",
            "metadata": {
                "description": "The base URI where artifacts required by this template are located. When the template is deployed using the accompanying scripts, a private location in the subscription will be used and this value will be automatically generated."
            },
            "defaultValue": "[deployment().properties.templateLink.uri]"
        },
        "_artifactsLocationSasToken": {
            "type": "securestring",
            "metadata": {
                "description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated."
            },
            "defaultValue": ""
        },
        "customData": {
            "type": "string",
            "defaultValue": "echo customData",
            "metadata": {
                "description": "String passed down to the Virtual Machine."
            }
        },
        "tagsByResource": {
            "type": "object",
            "defaultValue": {},
            "metadata": {
                "description": "tags by resources to update in resources"
            }
        },
        "zone": {
            "type": "string",
            "defaultValue": ""
        }
    },
    "variables": {
        "zones": [
            "[parameters('zone')]"
        ],
        "imageReference": {
            "Windows Server 2019": {
                "publisher": "MicrosoftWindowsServer",
                "offer": "WindowsServer",
                "sku": "2019-Datacenter",
                "version": "latest"
            }
        },
        "rootDiskType": "[parameters('rootDiskType')]",
        "rootDiskSize": "[parameters('rootDiskSize')]"
    },
    "resources": [
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-07-01",
            "name": "[parameters('vmName')]",
            "location": "[parameters('location')]",
            "dependsOn": [
            ],
            "identity": {
                "type": "[parameters('vmIdentitySetting')]"
            },
            "tags": {
            },
            "zones": "[if(not(equals(parameters('zone'),'')),variables('zones'),'')]",
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[parameters('vmSize')]"
                },
                "osProfile": {
                    "computerName": "[parameters('vmName')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]",
                    "customData": "[base64(parameters('customData'))]"
                },
                "storageProfile": {
                    "imageReference": "[variables('imageReference')[parameters('OS')]]",
                    "osDisk": {
                        "name": "[concat(parameters('vmName'), '-OSDisk')]",
                        "caching": "ReadWrite",
                        "createOption": "FromImage",
//                        "diskSizeGB": "[variables('rootDiskSize')]",
                        "managedDisk": {
                            "storageAccountType": "[variables('rootDiskType')]"
                        } 

                    },
                    "dataDisks": [
                        {
                            "name": "[concat(parameters('vmName'), '-DataDisk1')]",
                            "diskSizeGB": 1,
                            "lun": 0,
                            "createOption": "Empty",
                            "managedDisk": {
                                "storageAccountType": "[variables('rootDiskType')]"
                            }
                        }
                    ]
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', parameters('nicName'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[reference(resourceId('Microsoft.Storage/storageAccounts/', parameters('storageAccountName')), '2018-02-01').primaryEndpoints.blob]"
                    }
                }
            }
        }
    ],
    "outputs": {
        "resourceID": {
            "type": "string",
            "value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
        },
        "vmPrincipalID": {
            "type": "string",
            "value": "[if(equals(parameters('vmIdentitySetting'), 'None'), 'None', reference(resourceId('Microsoft.Compute/virtualMachines', parameters('vmName')), '2019-07-01', 'full').identity.principalId)]"
        }
    }
}
